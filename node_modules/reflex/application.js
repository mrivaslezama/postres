"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.start = exports.beginner = undefined;

var _task = require("./task");

var _effects = require("./effects");

var _dom = require("./dom");

var _reflexDriver = require("reflex-driver");

var _subscription = require("./subscription");

class Application {
  constructor(send, model, view, task, services) {
    this.send = send;
    this.model = model;
    this.view = view;
    this.task = task;
    this.services = services;
  }

}

const first = xs => xs[0];
const second = xs => xs[1];

const beginner = exports.beginner = configuration => ({
  flags: void 0,
  init: _ => [configuration.model, _effects.Effects.none],
  update: (model, action) => [configuration.update(model, action), _effects.Effects.none],
  view: configuration.view,
  subscriptions: _subscription.unsubscribe
});

const start = exports.start = (configuration, drive) => {
  const { init, view, update, flags } = configuration;
  const subscriptions = configuration.subscriptions == null ? _subscription.unsubscribe : configuration.subscriptions;

  const send = action => {
    const [model, fx] = update(application.model, action);
    application.model = model;
    application.view = new _dom.LazyRoot(view, model, send);
    application.task = fx.execute(send);

    application.services = subscriptions(model).reduce(subscribe, application.services);
    exectueServices(application.services, send);
    drive(application);
  };

  const [state, fx] = init(flags);

  const application = new Application(send, state, new _dom.LazyRoot(view, state, send), fx.execute(send), subscriptions(state).reduce(subscribe, {
    nextAddress: 0,
    outbox: send,
    active: Object.create(null)
  }));

  exectueServices(application.services, send);
  drive(application);
  return application;
};

const subscribe = (services, subscription) => {
  const { active, outbox } = services;
  const { feed, detail, tagger } = subscription;
  const service = active[String(feed.address)];

  if (service == null || service.feed !== feed) {
    const address = `/${++services.nextAddress}`;
    active[address] = spawnService(address, subscription, feed, outbox);
  } else {
    service.subscribers.push(subscription);
  }

  return services;
};

const spawnService = (address, subscription, feed, outbox) => {
  const subscribers = [subscription];
  const state = feed.init();
  feed.address = address;
  const send = input => {
    const [state, fx] = feed.update(service.state, input, outbox);
    service.state = state;
    fx.execute(send);
  };

  const service = {
    feed,
    subscribers,
    state,
    inbox: send
  };

  return service;
};

const exectueServices = (services, send) => {
  for (let address in services.active) {
    exectueService(services.active[address], send);
  }
};

const exectueService = (service, outbox) => {
  const { state, feed, subscribers, inbox } = service;
  const [next, fx] = feed.update(state, feed.subscribe(subscribers), outbox);
  service.state = next;
  fx.execute(inbox);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9hcHBsaWNhdGlvbi5qcyJdLCJuYW1lcyI6WyJBcHBsaWNhdGlvbiIsImNvbnN0cnVjdG9yIiwic2VuZCIsIm1vZGVsIiwidmlldyIsInRhc2siLCJzZXJ2aWNlcyIsImZpcnN0IiwieHMiLCJzZWNvbmQiLCJiZWdpbm5lciIsImNvbmZpZ3VyYXRpb24iLCJmbGFncyIsImluaXQiLCJfIiwibm9uZSIsInVwZGF0ZSIsImFjdGlvbiIsInN1YnNjcmlwdGlvbnMiLCJzdGFydCIsImRyaXZlIiwiZngiLCJhcHBsaWNhdGlvbiIsImV4ZWN1dGUiLCJyZWR1Y2UiLCJzdWJzY3JpYmUiLCJleGVjdHVlU2VydmljZXMiLCJzdGF0ZSIsIm5leHRBZGRyZXNzIiwib3V0Ym94IiwiYWN0aXZlIiwiT2JqZWN0IiwiY3JlYXRlIiwic3Vic2NyaXB0aW9uIiwiZmVlZCIsImRldGFpbCIsInRhZ2dlciIsInNlcnZpY2UiLCJTdHJpbmciLCJhZGRyZXNzIiwic3Bhd25TZXJ2aWNlIiwic3Vic2NyaWJlcnMiLCJwdXNoIiwiaW5wdXQiLCJpbmJveCIsImV4ZWN0dWVTZXJ2aWNlIiwibmV4dCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQTJCQSxNQUFNQSxXQUFOLENBQWtDO0FBQ2hDQyxjQUNFQyxJQURGLEVBRUVDLEtBRkYsRUFHRUMsSUFIRixFQUlFQyxJQUpGLEVBS0VDLFFBTEYsRUFNRTtBQUNBLFNBQUtKLElBQUwsR0FBWUEsSUFBWjtBQUNBLFNBQUtDLEtBQUwsR0FBYUEsS0FBYjtBQUNBLFNBQUtDLElBQUwsR0FBWUEsSUFBWjtBQUNBLFNBQUtDLElBQUwsR0FBWUEsSUFBWjtBQUNBLFNBQUtDLFFBQUwsR0FBZ0JBLFFBQWhCO0FBQ0Q7O0FBYitCOztBQTBDbEMsTUFBTUMsUUFBZUMsRUFBUCxJQUF5QkEsR0FBRyxDQUFILENBQXZDO0FBQ0EsTUFBTUMsU0FBZ0JELEVBQVAsSUFBeUJBLEdBQUcsQ0FBSCxDQUF4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QUNBUSxVQUFRVixLQUFSLEdBQWdCbUIsSUFBaEI7QUFDQXpCLEtBQUdFLE9BQUgsQ0FBV3FCLEtBQVg7QUFDRCxDQVJEIiwiZmlsZSI6ImFwcGxpY2F0aW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyogQGZsb3cgKi9cblxuaW1wb3J0IHsgVGFzayB9IGZyb20gXCIuL3Rhc2tcIlxuaW1wb3J0IHsgRWZmZWN0cyB9IGZyb20gXCIuL2VmZmVjdHNcIlxuaW1wb3J0IHsgTGF6eVJvb3QgfSBmcm9tIFwiLi9kb21cIlxuaW1wb3J0IHsgTm9kZSB9IGZyb20gXCJyZWZsZXgtZHJpdmVyXCJcbmltcG9ydCB0eXBlIHsgQWRkcmVzcyB9IGZyb20gXCIuL3NpZ25hbFwiXG5pbXBvcnQgeyBTdWJzY3JpcHRpb24sIEZlZWQsIHVuc3Vic2NyaWJlIH0gZnJvbSBcIi4vc3Vic2NyaXB0aW9uXCJcbmltcG9ydCB0eXBlIHsgU2VydmljZSwgU3Vic2NyaWJlLCBTdWJzY3JpYmVyIH0gZnJvbSBcIi4vc3Vic2NyaXB0aW9uXCJcblxuZXhwb3J0IHR5cGUgSW5pdDxtb2RlbCwgYWN0aW9uLCBmbGFncz4gPSAoXG4gIGZsYWdzOiBmbGFnc1xuKSA9PiBbbW9kZWwsIEVmZmVjdHM8YWN0aW9uPl1cblxuZXhwb3J0IHR5cGUgVXBkYXRlPG1vZGVsLCBhY3Rpb24+ID0gKFxuICBzdGF0ZTogbW9kZWwsXG4gIGFjdGlvbjogYWN0aW9uXG4pID0+IFttb2RlbCwgRWZmZWN0czxhY3Rpb24+XVxuXG5leHBvcnQgdHlwZSBWaWV3PG1vZGVsLCBhY3Rpb24+ID0gKFxuICBzdGF0ZTogbW9kZWwsXG4gIGFkZHJlc3M6IEFkZHJlc3M8YWN0aW9uPlxuKSA9PiBOb2RlXG5cbmV4cG9ydCB0eXBlIFN1YnNjcmlwdGlvbnM8bW9kZWwsIGFjdGlvbj4gPSAoXG4gIHN0YXRlOiBtb2RlbFxuKSA9PiBTdWJzY3JpcHRpb248YWN0aW9uPlxuXG50eXBlIFNlcnZpY2VzPG1lc3NhZ2U+ID0ge1xuICBuZXh0QWRkcmVzczogbnVtYmVyLFxuICBvdXRib3g6IEFkZHJlc3M8bWVzc2FnZT4sXG4gIGFjdGl2ZTogeyBba2V5OiBzdHJpbmddOiBTZXJ2aWNlPG1lc3NhZ2UsICosICosICosICo+IH1cbn1cblxuY2xhc3MgQXBwbGljYXRpb248c3RhdGUsIG1lc3NhZ2U+IHtcbiAgY29uc3RydWN0b3IoXG4gICAgc2VuZDogQWRkcmVzczxtZXNzYWdlPixcbiAgICBtb2RlbDogc3RhdGUsXG4gICAgdmlldzogTm9kZSxcbiAgICB0YXNrOiBUYXNrPGVtcHR5LCB2b2lkPixcbiAgICBzZXJ2aWNlczogU2VydmljZXM8bWVzc2FnZT5cbiAgKSB7XG4gICAgdGhpcy5zZW5kID0gc2VuZFxuICAgIHRoaXMubW9kZWwgPSBtb2RlbFxuICAgIHRoaXMudmlldyA9IHZpZXdcbiAgICB0aGlzLnRhc2sgPSB0YXNrXG4gICAgdGhpcy5zZXJ2aWNlcyA9IHNlcnZpY2VzXG4gIH1cblxuICBzZW5kOiBBZGRyZXNzPG1lc3NhZ2U+XG4gIG1vZGVsOiBzdGF0ZVxuICB2aWV3OiBOb2RlXG4gIHRhc2s6IFRhc2s8ZW1wdHksIHZvaWQ+XG4gIHNlcnZpY2VzOiBTZXJ2aWNlczxtZXNzYWdlPlxufVxuXG5leHBvcnQgdHlwZSB7IEFwcGxpY2F0aW9uIH1cblxuZXhwb3J0IHR5cGUgRHJpdmVyPG1vZGVsLCBtZXNzYWdlPiA9IChcbiAgc3RhdGU6IEFwcGxpY2F0aW9uPG1vZGVsLCBtZXNzYWdlPlxuKSA9PiB2b2lkXG5cbmV4cG9ydCB0eXBlIEJlZ2lubmVyQ29uZmlndXJhdGlvbjxtb2RlbCwgYWN0aW9uPiA9IHtcbiAgbW9kZWw6IG1vZGVsLFxuICB1cGRhdGU6IChtb2RlbDogbW9kZWwsIGFjdGlvbjogYWN0aW9uKSA9PiBtb2RlbCxcbiAgdmlldzogVmlldzxtb2RlbCwgYWN0aW9uPlxufVxuXG5leHBvcnQgdHlwZSBBZHZhbmNlZENvbmZpZ3VyYXRpb248bW9kZWwsIGFjdGlvbiwgZmxhZ3M+ID0ge1xuICBmbGFnczogZmxhZ3MsXG4gIGluaXQ6IEluaXQ8bW9kZWwsIGFjdGlvbiwgZmxhZ3M+LFxuICB1cGRhdGU6IFVwZGF0ZTxtb2RlbCwgYWN0aW9uPixcbiAgdmlldzogVmlldzxtb2RlbCwgYWN0aW9uPixcbiAgc3Vic2NyaXB0aW9ucz86IFN1YnNjcmlwdGlvbnM8bW9kZWwsIGFjdGlvbj5cbn1cblxuY29uc3QgZmlyc3QgPSA8YSwgYj4oeHM6IFthLCBiXSk6IGEgPT4geHNbMF1cbmNvbnN0IHNlY29uZCA9IDxhLCBiPih4czogW2EsIGJdKTogYiA9PiB4c1sxXVxuXG5leHBvcnQgY29uc3QgYmVnaW5uZXIgPSA8bW9kZWwsIGFjdGlvbj4oXG4gIGNvbmZpZ3VyYXRpb246IEJlZ2lubmVyQ29uZmlndXJhdGlvbjxtb2RlbCwgYWN0aW9uPlxuKTogQWR2YW5jZWRDb25maWd1cmF0aW9uPG1vZGVsLCBhY3Rpb24sIHZvaWQ+ID0+ICh7XG4gIGZsYWdzOiB2b2lkIDAsXG4gIGluaXQ6IF8gPT4gW2NvbmZpZ3VyYXRpb24ubW9kZWwsIEVmZmVjdHMubm9uZV0sXG4gIHVwZGF0ZTogKG1vZGVsLCBhY3Rpb24pID0+IFtcbiAgICBjb25maWd1cmF0aW9uLnVwZGF0ZShtb2RlbCwgYWN0aW9uKSxcbiAgICBFZmZlY3RzLm5vbmVcbiAgXSxcbiAgdmlldzogY29uZmlndXJhdGlvbi52aWV3LFxuICBzdWJzY3JpcHRpb25zOiB1bnN1YnNjcmliZVxufSlcblxuZXhwb3J0IGNvbnN0IHN0YXJ0ID0gPG1vZGVsLCBtZXNzYWdlLCBvcHRpb25zPihcbiAgY29uZmlndXJhdGlvbjogQWR2YW5jZWRDb25maWd1cmF0aW9uPG1vZGVsLCBtZXNzYWdlLCBvcHRpb25zPixcbiAgZHJpdmU6IERyaXZlcjxtb2RlbCwgbWVzc2FnZT5cbik6IEFwcGxpY2F0aW9uPG1vZGVsLCBtZXNzYWdlPiA9PiB7XG4gIGNvbnN0IHsgaW5pdCwgdmlldywgdXBkYXRlLCBmbGFncyB9ID0gY29uZmlndXJhdGlvblxuICBjb25zdCBzdWJzY3JpcHRpb25zOiBTdWJzY3JpcHRpb25zPG1vZGVsLCBtZXNzYWdlPiA9XG4gICAgY29uZmlndXJhdGlvbi5zdWJzY3JpcHRpb25zID09IG51bGxcbiAgICAgID8gdW5zdWJzY3JpYmVcbiAgICAgIDogY29uZmlndXJhdGlvbi5zdWJzY3JpcHRpb25zXG5cbiAgY29uc3Qgc2VuZCA9IGFjdGlvbiA9PiB7XG4gICAgY29uc3QgW21vZGVsLCBmeF0gPSB1cGRhdGUoYXBwbGljYXRpb24ubW9kZWwsIGFjdGlvbilcbiAgICBhcHBsaWNhdGlvbi5tb2RlbCA9IG1vZGVsXG4gICAgYXBwbGljYXRpb24udmlldyA9IG5ldyBMYXp5Um9vdCh2aWV3LCBtb2RlbCwgc2VuZClcbiAgICBhcHBsaWNhdGlvbi50YXNrID0gZnguZXhlY3V0ZShzZW5kKVxuXG4gICAgYXBwbGljYXRpb24uc2VydmljZXMgPSBzdWJzY3JpcHRpb25zKG1vZGVsKS5yZWR1Y2UoXG4gICAgICBzdWJzY3JpYmUsXG4gICAgICBhcHBsaWNhdGlvbi5zZXJ2aWNlc1xuICAgIClcbiAgICBleGVjdHVlU2VydmljZXMoYXBwbGljYXRpb24uc2VydmljZXMsIHNlbmQpXG4gICAgZHJpdmUoYXBwbGljYXRpb24pXG4gIH1cblxuICBjb25zdCBbc3RhdGUsIGZ4XSA9IGluaXQoZmxhZ3MpXG5cbiAgY29uc3QgYXBwbGljYXRpb24gPSBuZXcgQXBwbGljYXRpb24oXG4gICAgc2VuZCxcbiAgICBzdGF0ZSxcbiAgICBuZXcgTGF6eVJvb3Qodmlldywgc3RhdGUsIHNlbmQpLFxuICAgIGZ4LmV4ZWN1dGUoc2VuZCksXG4gICAgc3Vic2NyaXB0aW9ucyhzdGF0ZSkucmVkdWNlKHN1YnNjcmliZSwge1xuICAgICAgbmV4dEFkZHJlc3M6IDAsXG4gICAgICBvdXRib3g6IHNlbmQsXG4gICAgICBhY3RpdmU6IE9iamVjdC5jcmVhdGUobnVsbClcbiAgICB9KVxuICApXG5cbiAgZXhlY3R1ZVNlcnZpY2VzKGFwcGxpY2F0aW9uLnNlcnZpY2VzLCBzZW5kKVxuICBkcml2ZShhcHBsaWNhdGlvbilcbiAgcmV0dXJuIGFwcGxpY2F0aW9uXG59XG5cbmNvbnN0IHN1YnNjcmliZSA9IDxtZXNzYWdlLCBvdXQsIGlubiwgbW9kZWwsIGluZm8+KFxuICBzZXJ2aWNlczogU2VydmljZXM8bWVzc2FnZT4sXG4gIHN1YnNjcmlwdGlvbjogU3Vic2NyaWJlPG1lc3NhZ2UsIG91dCwgaW5uLCBtb2RlbCwgaW5mbz5cbik6IFNlcnZpY2VzPG1lc3NhZ2U+ID0+IHtcbiAgY29uc3QgeyBhY3RpdmUsIG91dGJveCB9ID0gc2VydmljZXNcbiAgY29uc3QgeyBmZWVkLCBkZXRhaWwsIHRhZ2dlciB9ID0gc3Vic2NyaXB0aW9uXG4gIGNvbnN0IHNlcnZpY2UgPSBhY3RpdmVbU3RyaW5nKGZlZWQuYWRkcmVzcyldXG5cbiAgaWYgKHNlcnZpY2UgPT0gbnVsbCB8fCBzZXJ2aWNlLmZlZWQgIT09IGZlZWQpIHtcbiAgICBjb25zdCBhZGRyZXNzID0gYC8keysrc2VydmljZXMubmV4dEFkZHJlc3N9YCAvL2BcbiAgICBhY3RpdmVbYWRkcmVzc10gPSBzcGF3blNlcnZpY2UoYWRkcmVzcywgc3Vic2NyaXB0aW9uLCBmZWVkLCBvdXRib3gpXG4gIH0gZWxzZSB7XG4gICAgc2VydmljZS5zdWJzY3JpYmVycy5wdXNoKHN1YnNjcmlwdGlvbilcbiAgfVxuXG4gIHJldHVybiBzZXJ2aWNlc1xufVxuXG5jb25zdCBzcGF3blNlcnZpY2UgPSA8bWVzc2FnZSwgb3V0LCBpbm4sIG1vZGVsLCBpbmZvPihcbiAgYWRkcmVzczogc3RyaW5nLFxuICBzdWJzY3JpcHRpb246IFN1YnNjcmliZXI8aW5mbywgb3V0LCBtZXNzYWdlPixcbiAgZmVlZDogRmVlZDxvdXQsIGlubiwgbW9kZWwsIGluZm8+LFxuICBvdXRib3g6IEFkZHJlc3M8bWVzc2FnZT5cbik6IFNlcnZpY2U8bWVzc2FnZSwgb3V0LCBpbm4sIG1vZGVsLCBpbmZvPiA9PiB7XG4gIGNvbnN0IHN1YnNjcmliZXJzID0gW3N1YnNjcmlwdGlvbl1cbiAgY29uc3Qgc3RhdGUgPSBmZWVkLmluaXQoKVxuICBmZWVkLmFkZHJlc3MgPSBhZGRyZXNzXG4gIGNvbnN0IHNlbmQgPSAoaW5wdXQ6IGlubikgPT4ge1xuICAgIGNvbnN0IFtzdGF0ZSwgZnhdID0gZmVlZC51cGRhdGUoc2VydmljZS5zdGF0ZSwgaW5wdXQsIG91dGJveClcbiAgICBzZXJ2aWNlLnN0YXRlID0gc3RhdGVcbiAgICBmeC5leGVjdXRlKHNlbmQpXG4gIH1cblxuICBjb25zdCBzZXJ2aWNlID0ge1xuICAgIGZlZWQsXG4gICAgc3Vic2NyaWJlcnMsXG4gICAgc3RhdGUsXG4gICAgaW5ib3g6IHNlbmRcbiAgfVxuXG4gIHJldHVybiBzZXJ2aWNlXG59XG5cbmNvbnN0IGV4ZWN0dWVTZXJ2aWNlcyA9IDxhPihzZXJ2aWNlczogU2VydmljZXM8YT4sIHNlbmQ6IEFkZHJlc3M8YT4pID0+IHtcbiAgZm9yIChsZXQgYWRkcmVzcyBpbiBzZXJ2aWNlcy5hY3RpdmUpIHtcbiAgICBleGVjdHVlU2VydmljZShzZXJ2aWNlcy5hY3RpdmVbYWRkcmVzc10sIHNlbmQpXG4gIH1cbn1cblxuY29uc3QgZXhlY3R1ZVNlcnZpY2UgPSA8b3V0LCBpbm4sIG1zZywgbW9kZWwsIGluZm8+KFxuICBzZXJ2aWNlOiBTZXJ2aWNlPG91dCwgaW5uLCBtc2csIG1vZGVsLCBpbmZvPixcbiAgb3V0Ym94OiBBZGRyZXNzPG91dD5cbikgPT4ge1xuICBjb25zdCB7IHN0YXRlLCBmZWVkLCBzdWJzY3JpYmVycywgaW5ib3ggfSA9IHNlcnZpY2VcbiAgY29uc3QgW25leHQsIGZ4XSA9IGZlZWQudXBkYXRlKHN0YXRlLCBmZWVkLnN1YnNjcmliZShzdWJzY3JpYmVycyksIG91dGJveClcbiAgc2VydmljZS5zdGF0ZSA9IG5leHRcbiAgZnguZXhlY3V0ZShpbmJveClcbn1cbiJdfQ==